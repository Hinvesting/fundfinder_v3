<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FundFinder - AI Funding Search</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .fade-in { animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .modal { display: none; position: fixed; z-index: 50; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
        .modal.active { display: flex; align-items: center; justify-content: center; }
        .modal-content { background-color: #fefefe; margin: auto; padding: 0; border-radius: 8px; max-width: 500px; width: 90%; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen flex flex-col">

    <!-- Navigation -->
    <nav class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <i class="fas fa-search-dollar text-blue-600 text-2xl mr-2"></i>
                    <span class="font-bold text-xl tracking-tight text-gray-900">FundFinder</span>
                </div>
                <!-- Navigation Actions (Dynamic) -->
                <div class="flex items-center space-x-3" id="nav-actions">
                    <!-- Guest View: Sign In + Join Free -->
                    <button onclick="openAuthModal('login')" id="signin-btn" class="text-gray-600 hover:text-blue-600 font-medium px-3 py-2 rounded-md text-sm">
                        Sign In
                    </button>
                    <button onclick="openAuthModal('register')" id="join-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-medium px-4 py-2 rounded-md text-sm">
                        Join Free
                    </button>
                    <!-- Logged In View (hidden by default) -->
                    <a href="#" id="saved-link" class="hidden text-gray-600 hover:text-blue-600 font-medium px-3 py-2 rounded-md text-sm">
                        <i class="fas fa-bookmark mr-1"></i> Saved
                    </a>
                    <div id="user-menu" class="hidden flex items-center space-x-3">
                        <span class="text-gray-600 text-sm" id="user-email"></span>
                        <div class="h-8 w-8 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 font-bold cursor-pointer" id="user-avatar">U</div>
                        <button onclick="logout()" class="text-gray-600 hover:text-red-600 font-medium text-sm">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Auth Modal -->
    <div id="auth-modal" class="modal">
        <div class="modal-content">
            <!-- Modal Header with Toggle -->
            <div class="bg-gray-50 px-6 py-4 border-b border-gray-200">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold text-gray-900" id="modal-title">Welcome Back</h2>
                    <button onclick="closeAuthModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <!-- Toggle Between Login/Register -->
                <div class="flex space-x-2 bg-white rounded-lg p-1 border border-gray-200">
                    <button onclick="switchAuthMode('login')" id="tab-login" class="flex-1 py-2 px-4 rounded-md text-sm font-medium transition bg-blue-600 text-white">
                        Login
                    </button>
                    <button onclick="switchAuthMode('register')" id="tab-register" class="flex-1 py-2 px-4 rounded-md text-sm font-medium transition text-gray-600 hover:text-gray-900">
                        Register
                    </button>
                </div>
            </div>
            
            <!-- Modal Body -->
            <div class="px-6 py-6">
                <!-- Login Form -->
                <form id="login-form" onsubmit="handleLogin(event)">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                            <input type="email" id="login-email" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="you@example.com">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                            <input type="password" id="login-password" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="••••••••">
                        </div>
                        <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md transition">
                            Sign In
                        </button>
                    </div>
                </form>

                <!-- Register Form (Hidden by default) -->
                <form id="register-form" class="hidden" onsubmit="handleRegister(event)">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                            <input type="text" id="register-name" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="John Doe">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                            <input type="email" id="register-email" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="you@example.com">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                            <input type="password" id="register-password" required minlength="6" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="••••••••">
                        </div>
                        <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md transition">
                            Create Account
                        </button>
                    </div>
                </form>

                <!-- Error Message -->
                <div id="auth-error" class="hidden mt-4 bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-md text-sm"></div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="flex-grow container mx-auto px-4 py-8">
        
        <!-- Search Form (Always Visible) -->
        <div class="max-w-4xl mx-auto fade-in">
            <div class="text-center mb-8">
                <h1 class="text-4xl font-extrabold text-gray-900">
                    Find Capital for Your <span class="text-blue-600">Vision</span>
                </h1>
                <p class="mt-3 text-lg text-gray-500">
                    AI-powered search for Grants, Loans, and Angel Investors
                </p>
            </div>

            <div class="bg-white shadow overflow-hidden sm:rounded-lg mb-8">
                <div class="px-4 py-5 sm:px-6 border-b border-gray-200">
                    <h3 class="text-lg leading-6 font-medium text-gray-900">Search for Funding</h3>
                    <p class="mt-1 max-w-2xl text-sm text-gray-500">Tell us about your business needs.</p>
                </div>
                <div class="px-4 py-5 sm:p-6">
                    <form id="search-form" onsubmit="handleSearch(event)">
                        <div class="grid grid-cols-1 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Business Type</label>
                                <select id="biz-type" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                                    <option>Tech Startup</option>
                                    <option>Restaurant</option>
                                    <option>Retail Store</option>
                                    <option>Non-Profit / NGO</option>
                                    <option>Freelancer / Creative</option>
                                    <option>Small Business (Service)</option>
                                    <option>Manufacturing</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Location</label>
                                <input type="text" id="location" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" placeholder="e.g. Seattle, Washington" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Funding Purpose</label>
                                <textarea id="purpose" rows="3" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" placeholder="e.g. Need $10,000 for equipment to expand services"></textarea>
                            </div>
                            <button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-base font-medium text-white bg-blue-600 hover:bg-blue-700 transition">
                                <i class="fas fa-magic mr-2 mt-1"></i> Find Funding with AI
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Loading State -->
            <div id="loader-area" class="hidden flex flex-col items-center justify-center py-12">
                <div class="loader mb-4"></div>
                <p class="text-gray-500 animate-pulse">AI is analyzing funding sources...</p>
            </div>

            <!-- Results Area -->
            <div id="results-area" class="hidden space-y-4">
                <h2 class="text-2xl font-bold text-gray-900 mb-4">Tailored Opportunities</h2>
                <div id="results-container" class="space-y-4"></div>
            </div>

            <!-- Error Area -->
            <div id="error-area" class="hidden bg-red-50 border-l-4 border-red-500 p-4 mb-6">
                <p class="text-red-700" id="error-msg">Something went wrong.</p>
            </div>
        </div>
    </main>

    <script>
        // --- GLOBAL STATE ---
        let currentUser = null;

        // --- CHECK AUTH STATUS ON LOAD ---
        async function checkAuthStatus() {
            try {
                const response = await fetch('/api/me');
                const data = await response.json();
                
                if (data.authenticated) {
                    currentUser = data.user;
                    updateUIForLoggedIn();
                }
            } catch (err) {
                console.error('Auth check failed:', err);
            }
        }

        // --- AUTH MODAL FUNCTIONS ---
        function openAuthModal(mode = 'login') {
            document.getElementById('auth-modal').classList.add('active');
            switchAuthMode(mode);
        }

        function closeAuthModal() {
            document.getElementById('auth-modal').classList.remove('active');
            document.getElementById('auth-error').classList.add('hidden');
        }

        function switchAuthMode(mode) {
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            const loginTab = document.getElementById('tab-login');
            const registerTab = document.getElementById('tab-register');
            const modalTitle = document.getElementById('modal-title');

            if (mode === 'login') {
                loginForm.classList.remove('hidden');
                registerForm.classList.add('hidden');
                loginTab.classList.add('bg-blue-600', 'text-white');
                loginTab.classList.remove('text-gray-600');
                registerTab.classList.remove('bg-blue-600', 'text-white');
                registerTab.classList.add('text-gray-600');
                modalTitle.textContent = 'Welcome Back';
            } else {
                registerForm.classList.remove('hidden');
                loginForm.classList.add('hidden');
                registerTab.classList.add('bg-blue-600', 'text-white');
                registerTab.classList.remove('text-gray-600');
                loginTab.classList.remove('bg-blue-600', 'text-white');
                loginTab.classList.add('text-gray-600');
                modalTitle.textContent = 'Create Account';
            }
            
            document.getElementById('auth-error').classList.add('hidden');
        }

        // --- AUTH HANDLERS ---
        async function handleLogin(event) {
            event.preventDefault();
            
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    currentUser = data.user;
                    updateUIForLoggedIn();
                    closeAuthModal();
                } else {
                    showAuthError(data.error || 'Login failed');
                }
            } catch (err) {
                showAuthError('Network error. Please try again.');
            }
        }

        async function handleRegister(event) {
            event.preventDefault();
            
            const name = document.getElementById('register-name').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            
            try {
                const response = await fetch('/api/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, email, password })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    currentUser = data.user;
                    updateUIForLoggedIn();
                    closeAuthModal();
                } else {
                    showAuthError(data.error || 'Registration failed');
                }
            } catch (err) {
                showAuthError('Network error. Please try again.');
            }
        }

        async function logout() {
            try {
                await fetch('/api/logout', { method: 'POST' });
                currentUser = null;
                updateUIForLoggedOut();
            } catch (err) {
                console.error('Logout failed:', err);
            }
        }

        function showAuthError(message) {
            const errorDiv = document.getElementById('auth-error');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
        }

        // --- UI UPDATE FUNCTIONS ---
        function updateUIForLoggedIn() {
            // Hide guest buttons
            document.getElementById('signin-btn').classList.add('hidden');
            document.getElementById('join-btn').classList.add('hidden');
            
            // Show logged-in elements
            document.getElementById('saved-link').classList.remove('hidden');
            document.getElementById('user-menu').classList.remove('hidden');
            document.getElementById('user-email').textContent = currentUser.email;
            document.getElementById('user-avatar').textContent = currentUser.name.charAt(0).toUpperCase();
        }

        function updateUIForLoggedOut() {
            // Show guest buttons
            document.getElementById('signin-btn').classList.remove('hidden');
            document.getElementById('join-btn').classList.remove('hidden');
            
            // Hide logged-in elements
            document.getElementById('saved-link').classList.add('hidden');
            document.getElementById('user-menu').classList.add('hidden');
            
            // Clear any results
            document.getElementById('results-area').classList.add('hidden');
        }

        // --- SEARCH HANDLER ---
        async function handleSearch(event) {
            event.preventDefault();
            
            // Check if user is logged in
            if (!currentUser) {
                openAuthModal('register');
                return;
            }
            
            const type = document.getElementById('biz-type').value;
            const location = document.getElementById('location').value;
            const purpose = document.getElementById('purpose').value;

            // Reset UI
            document.getElementById('results-area').classList.add('hidden');
            document.getElementById('error-area').classList.add('hidden');
            document.getElementById('loader-area').classList.remove('hidden');

            try {
                const response = await fetch('/api/search', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type, location, purpose })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Search failed');
                }

                renderResults(data);

            } catch (err) {
                console.error(err);
                document.getElementById('error-msg').textContent = err.message;
                document.getElementById('error-area').classList.remove('hidden');
            } finally {
                document.getElementById('loader-area').classList.add('hidden');
            }
        }

        // --- RENDER RESULTS ---
        function renderResults(results) {
            const container = document.getElementById('results-container');
            let html = '';

            results.forEach(item => {
                let borderClass = 'border-blue-500';
                let bgClass = 'bg-blue-100 text-blue-800';
                
                if (item.type && item.type.toLowerCase().includes('grant')) {
                    borderClass = 'border-green-500';
                    bgClass = 'bg-green-100 text-green-800';
                } else if (item.type && item.type.toLowerCase().includes('loan')) {
                    borderClass = 'border-purple-500';
                    bgClass = 'bg-purple-100 text-purple-800';
                }

                html += `
                <div class="bg-white shadow rounded-lg p-6 border-l-4 ${borderClass} hover:shadow-md transition">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${bgClass}">${item.type || 'Opportunity'}</span>
                            <h4 class="text-xl font-bold text-gray-900 mt-2">${item.name}</h4>
                            <p class="text-sm text-gray-600 mt-2">${item.match_reason || ''}</p>
                        </div>
                        <div class="text-right ml-4">
                            <div class="font-bold text-lg text-gray-900">${item.amount || 'Varies'}</div>
                            <div class="text-xs text-gray-500 mt-1">Due: ${item.deadline || 'Rolling'}</div>
                        </div>
                    </div>
                    <div class="mt-4 pt-4 border-t border-gray-100 flex justify-between items-center">
                        <button onclick="saveItem(${JSON.stringify(item).replace(/"/g, '&quot;')})" class="text-gray-600 hover:text-blue-600 font-medium text-sm">
                            <i class="fas fa-bookmark mr-1"></i> Save
                        </button>
                        <a href="${item.link || '#'}" target="_blank" class="text-blue-600 hover:text-blue-800 font-medium text-sm flex items-center">
                            Apply Now <i class="fas fa-external-link-alt ml-2"></i>
                        </a>
                    </div>
                </div>`;
            });

            container.innerHTML = html;
            document.getElementById('results-area').classList.remove('hidden');
        }

        // --- SAVE ITEM ---
        async function saveItem(item) {
            try {
                const response = await fetch('/api/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(item)
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert('Opportunity saved successfully!');
                } else {
                    alert('Failed to save: ' + (data.error || 'Unknown error'));
                }
            } catch (err) {
                alert('Network error. Please try again.');
            }
        }

        // --- INITIALIZE ON LOAD ---
        window.addEventListener('DOMContentLoaded', () => {
            checkAuthStatus();
            
            // Close modal when clicking outside
            window.onclick = function(event) {
                const modal = document.getElementById('auth-modal');
                if (event.target === modal) {
                    closeAuthModal();
                }
            }
        });
    </script>
</body>
</html>