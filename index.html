<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FundFinder - AI Funding Search</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .fade-in { animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .modal { 
            display: none; 
            position: fixed; 
            z-index: 50; 
            left: 0; 
            top: 0; 
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.5); 
        }
        .modal.active { 
            display: flex; 
            align-items: center; 
            justify-content: center; 
        }
        .modal-content { 
            background-color: #fefefe; 
            margin: auto; 
            padding: 0; 
            border-radius: 12px; 
            max-width: 480px; 
            width: 90%; 
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen flex flex-col">

    <!-- Navigation -->
    <nav class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <i class="fas fa-search-dollar text-blue-600 text-2xl mr-2"></i>
                    <span class="font-bold text-xl tracking-tight text-gray-900">FundFinder</span>
                </div>
                
                <!-- Dynamic Navigation Actions -->
                <div class="flex items-center space-x-3" id="nav-actions">
                    <!-- GUEST VIEW (Default) -->
                    <button onclick="openAuthModal('login')" id="signin-btn" class="text-gray-600 hover:text-blue-600 font-medium px-4 py-2 rounded-md text-sm transition">
                        Sign In
                    </button>
                    <button onclick="openAuthModal('register')" id="join-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-medium px-4 py-2 rounded-md text-sm shadow-sm transition">
                        Join Free
                    </button>
                    
                    <!-- LOGGED IN VIEW (Hidden by default) -->
                    <button onclick="startCheckout()" id="upgrade-btn" class="hidden bg-gradient-to-r from-yellow-500 to-orange-500 hover:from-yellow-600 hover:to-orange-600 text-white font-semibold px-4 py-2 rounded-md text-sm shadow-sm transition">
                        <i class="fas fa-crown mr-1"></i> Upgrade to Pro
                    </button>
                    <button onclick="openPortal()" id="portal-btn" class="hidden bg-purple-600 hover:bg-purple-700 text-white font-semibold px-4 py-2 rounded-md text-sm shadow-sm transition">
                        <i class="fas fa-cog mr-1"></i> Manage Subscription
                    </button>
                    <a href="#saved" onclick="loadSavedItems(event)" id="saved-link" class="hidden text-gray-600 hover:text-blue-600 font-medium px-3 py-2 rounded-md text-sm transition">
                        <i class="fas fa-bookmark mr-1"></i> Saved
                    </a>
                    <div id="user-info" class="hidden flex items-center space-x-3">
                        <span class="text-gray-600 text-sm font-medium" id="user-email"></span>
                        <div class="h-9 w-9 bg-gradient-to-br from-blue-500 to-blue-600 rounded-full flex items-center justify-center text-white font-bold shadow-sm cursor-pointer" id="user-avatar" title="User Profile">
                            U
                        </div>
                        <button onclick="handleLogout()" class="text-gray-600 hover:text-red-600 font-medium text-sm transition">
                            <i class="fas fa-sign-out-alt mr-1"></i> Sign Out
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Auth Modal -->
    <div id="auth-modal" class="modal">
        <div class="modal-content">
            <!-- Modal Header -->
            <div class="px-6 py-5 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <h2 class="text-2xl font-bold text-gray-900" id="modal-title">Welcome Back</h2>
                    <button onclick="closeAuthModal()" class="text-gray-400 hover:text-gray-600 transition">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            
            <!-- Modal Body -->
            <div class="px-6 py-6">
                <!-- LOGIN FORM -->
                <form id="login-form" onsubmit="handleLogin(event)">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Email Address</label>
                            <input 
                                type="email" 
                                id="login-email" 
                                required 
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition" 
                                placeholder="you@example.com"
                            >
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                            <input 
                                type="password" 
                                id="login-password" 
                                required 
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition" 
                                placeholder="••••••••"
                            >
                        </div>
                        <button 
                            type="submit" 
                            class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-4 rounded-lg transition shadow-sm"
                        >
                            Sign In
                        </button>
                        <div class="text-center pt-2">
                            <button 
                                type="button" 
                                onclick="switchToRegister()" 
                                class="text-sm text-blue-600 hover:text-blue-700 font-medium"
                            >
                                Need an account? <span class="underline">Sign Up</span>
                            </button>
                        </div>
                    </div>
                </form>

                <!-- REGISTER FORM (Hidden by default) -->
                <form id="register-form" class="hidden" onsubmit="handleRegister(event)">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                            <input 
                                type="text" 
                                id="register-name" 
                                required 
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition" 
                                placeholder="John Doe"
                            >
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Email Address</label>
                            <input 
                                type="email" 
                                id="register-email" 
                                required 
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition" 
                                placeholder="you@example.com"
                            >
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                            <input 
                                type="password" 
                                id="register-password" 
                                required 
                                minlength="6" 
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition" 
                                placeholder="••••••••"
                            >
                            <p class="text-xs text-gray-500 mt-1">Minimum 6 characters</p>
                        </div>
                        <button 
                            type="submit" 
                            class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-4 rounded-lg transition shadow-sm"
                        >
                            Create Account
                        </button>
                        <div class="text-center pt-2">
                            <button 
                                type="button" 
                                onclick="switchToLogin()" 
                                class="text-sm text-blue-600 hover:text-blue-700 font-medium"
                            >
                                Have an account? <span class="underline">Login</span>
                            </button>
                        </div>
                    </div>
                </form>

                <!-- Error/Success Messages -->
                <div id="auth-message" class="hidden mt-4 px-4 py-3 rounded-lg text-sm"></div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="flex-grow container mx-auto px-4 py-8">
        <div class="max-w-4xl mx-auto fade-in">
            
            <!-- Hero Section -->
            <div class="text-center mb-10">
                <h1 class="text-5xl font-extrabold text-gray-900 mb-4">
                    Find Capital for Your <span class="text-blue-600">Vision</span>
                </h1>
                <p class="text-xl text-gray-600 max-w-2xl mx-auto">
                    AI-powered search for Grants, Loans, and Angel Investors tailored to your business needs
                </p>
            </div>

            <!-- Search Form (ALWAYS EDITABLE) -->
            <div class="bg-white shadow-lg rounded-xl overflow-hidden mb-8 border border-gray-100">
                <div class="px-6 py-5 border-b border-gray-200 bg-gradient-to-r from-blue-50 to-white">
                    <h3 class="text-lg leading-6 font-semibold text-gray-900">
                        <i class="fas fa-search mr-2 text-blue-600"></i>Search for Funding
                    </h3>
                    <p class="mt-1 text-sm text-gray-600">Enter your business details to discover opportunities</p>
                </div>
                <div class="px-6 py-6">
                    <form id="search-form" onsubmit="handleSearchSubmit(event)">
                        <div class="space-y-5">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-briefcase text-gray-400 mr-1"></i> Business Type
                                </label>
                                <select 
                                    id="biz-type" 
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition bg-white"
                                >
                                    <option>Tech Startup</option>
                                    <option>Restaurant</option>
                                    <option>Retail Store</option>
                                    <option>Non-Profit / NGO</option>
                                    <option>Freelancer / Creative</option>
                                    <option>Small Business (Service)</option>
                                    <option>Manufacturing</option>
                                    <option>Healthcare</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-map-marker-alt text-gray-400 mr-1"></i> Location
                                </label>
                                <input 
                                    type="text" 
                                    id="location" 
                                    required 
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition" 
                                    placeholder="e.g. Seattle, Washington"
                                >
                                <p class="text-xs text-gray-500 mt-1">Be specific for better results (City, State)</p>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    <i class="fas fa-bullseye text-gray-400 mr-1"></i> Funding Purpose
                                </label>
                                <textarea 
                                    id="purpose" 
                                    rows="3" 
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition resize-none" 
                                    placeholder="e.g. Need $15,000 for commercial kitchen equipment to expand catering services"
                                ></textarea>
                            </div>
                            
                            <button 
                                type="submit" 
                                id="search-btn"
                                class="w-full bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white font-semibold py-4 px-6 rounded-lg shadow-md hover:shadow-lg transition transform hover:-translate-y-0.5 flex items-center justify-center"
                            >
                                <i class="fas fa-magic mr-2"></i> Find Funding with AI
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Loading State -->
            <div id="loader-area" class="hidden">
                <div class="bg-white shadow-lg rounded-xl p-8 text-center border border-gray-100">
                    <div class="loader mx-auto mb-4"></div>
                    <p class="text-gray-600 font-medium animate-pulse">AI is analyzing funding sources...</p>
                    <p class="text-sm text-gray-500 mt-2">This may take a few seconds</p>
                </div>
            </div>

            <!-- Results Area -->
            <div id="results-area" class="hidden space-y-4">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-3xl font-bold text-gray-900">
                        <i class="fas fa-star text-yellow-500 mr-2"></i>Tailored Opportunities
                    </h2>
                    <span class="text-sm text-gray-500" id="result-count"></span>
                </div>
                <div id="results-container" class="space-y-4"></div>
            </div>

            <!-- Error Area -->
            <div id="error-area" class="hidden">
                <div class="bg-red-50 border-l-4 border-red-500 p-5 rounded-lg">
                    <div class="flex items-start">
                        <i class="fas fa-exclamation-circle text-red-500 text-xl mr-3 mt-0.5"></i>
                        <div>
                            <h3 class="text-red-800 font-semibold">Error</h3>
                            <p class="text-red-700 mt-1" id="error-msg"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-white border-t border-gray-200 mt-12">
        <div class="max-w-7xl mx-auto px-4 py-6">
            <p class="text-center text-sm text-gray-500">
                © 2025 FundFinder v3 - Built by Hinvesting Team
            </p>
        </div>
    </footer>

    <script>
        // ==================== GLOBAL STATE ====================
        let currentUser = null;
        let isAuthenticated = false;
        let userSubscriptionStatus = 'free';

        // ==================== INITIALIZATION ====================
        window.addEventListener('DOMContentLoaded', async () => {
            await checkAuthStatus();
            
            // Close modal when clicking outside
            window.onclick = (event) => {
                const modal = document.getElementById('auth-modal');
                if (event.target === modal) {
                    closeAuthModal();
                }
            };
        });

        // ==================== AUTH STATUS CHECK ====================
        async function checkAuthStatus() {
            try {
                const response = await fetch('/api/me', {
                    method: 'GET',
                    credentials: 'same-origin'
                });
                
                const data = await response.json();
                
                if (data.authenticated && data.user) {
                    isAuthenticated = true;
                    currentUser = data.user;
                    userSubscriptionStatus = data.user.subscription_status || 'free';
                    updateNavForLoggedIn();
                } else {
                    isAuthenticated = false;
                    currentUser = null;
                    userSubscriptionStatus = 'free';
                    updateNavForGuest();
                }
            } catch (err) {
                console.error('Auth check failed:', err);
                isAuthenticated = false;
                userSubscriptionStatus = 'free';
                updateNavForGuest();
            }
        }

        // ==================== NAVIGATION UI UPDATES ====================
        function updateNavForLoggedIn() {
            // Hide guest buttons
            document.getElementById('signin-btn').classList.add('hidden');
            document.getElementById('join-btn').classList.add('hidden');
            
            // Show logged-in elements
            document.getElementById('saved-link').classList.remove('hidden');
            document.getElementById('user-info').classList.remove('hidden');
            
            // Show/hide upgrade or portal button based on subscription status
            const upgradeBtn = document.getElementById('upgrade-btn');
            const portalBtn = document.getElementById('portal-btn');
            
            if (userSubscriptionStatus === 'active') {
                // Pro user - show portal button
                upgradeBtn.classList.add('hidden');
                portalBtn.classList.remove('hidden');
            } else {
                // Free user - show upgrade button
                upgradeBtn.classList.remove('hidden');
                portalBtn.classList.add('hidden');
            }
            
            // Update user info
            document.getElementById('user-email').textContent = currentUser.email;
            const avatar = document.getElementById('user-avatar');
            avatar.textContent = currentUser.name.charAt(0).toUpperCase();
            avatar.title = currentUser.name;
        }

        function updateNavForGuest() {
            // Show guest buttons
            document.getElementById('signin-btn').classList.remove('hidden');
            document.getElementById('join-btn').classList.remove('hidden');
            
            // Hide logged-in elements
            document.getElementById('upgrade-btn').classList.add('hidden');
            document.getElementById('portal-btn').classList.add('hidden');
            document.getElementById('saved-link').classList.add('hidden');
            document.getElementById('user-info').classList.add('hidden');
        }

        // ==================== AUTH MODAL FUNCTIONS ====================
        function openAuthModal(mode = 'login') {
            document.getElementById('auth-modal').classList.add('active');
            if (mode === 'register') {
                switchToRegister();
            } else {
                switchToLogin();
            }
            clearAuthMessage();
        }

        function closeAuthModal() {
            document.getElementById('auth-modal').classList.remove('active');
            clearAuthMessage();
            clearForms();
        }

        function switchToLogin() {
            document.getElementById('login-form').classList.remove('hidden');
            document.getElementById('register-form').classList.add('hidden');
            document.getElementById('modal-title').textContent = 'Welcome Back';
            clearAuthMessage();
        }

        function switchToRegister() {
            document.getElementById('register-form').classList.remove('hidden');
            document.getElementById('login-form').classList.add('hidden');
            document.getElementById('modal-title').textContent = 'Create Account';
            clearAuthMessage();
        }

        function clearForms() {
            document.getElementById('login-form').reset();
            document.getElementById('register-form').reset();
        }

        function showAuthMessage(message, isError = false) {
            const msgDiv = document.getElementById('auth-message');
            msgDiv.textContent = message;
            msgDiv.classList.remove('hidden', 'bg-red-50', 'text-red-700', 'bg-green-50', 'text-green-700', 'border', 'border-red-200', 'border-green-200');
            
            if (isError) {
                msgDiv.classList.add('bg-red-50', 'text-red-700', 'border', 'border-red-200');
            } else {
                msgDiv.classList.add('bg-green-50', 'text-green-700', 'border', 'border-green-200');
            }
        }

        function clearAuthMessage() {
            const msgDiv = document.getElementById('auth-message');
            msgDiv.classList.add('hidden');
            msgDiv.textContent = '';
        }

        // ==================== AUTH HANDLERS ====================
        async function handleLogin(event) {
            event.preventDefault();
            
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value;
            
            if (!email || !password) {
                showAuthMessage('Please fill in all fields', true);
                return;
            }
            
            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'same-origin',
                    body: JSON.stringify({ email, password })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    isAuthenticated = true;
                    currentUser = data.user;
                    updateNavForLoggedIn();
                    closeAuthModal();
                    showAuthMessage('Login successful!', false);
                } else {
                    showAuthMessage(data.error || 'Login failed. Please try again.', true);
                }
            } catch (err) {
                console.error('Login error:', err);
                showAuthMessage('Network error. Please check your connection.', true);
            }
        }

        async function handleRegister(event) {
            event.preventDefault();
            
            const name = document.getElementById('register-name').value.trim();
            const email = document.getElementById('register-email').value.trim();
            const password = document.getElementById('register-password').value;
            
            if (!name || !email || !password) {
                showAuthMessage('Please fill in all fields', true);
                return;
            }
            
            if (password.length < 6) {
                showAuthMessage('Password must be at least 6 characters', true);
                return;
            }
            
            try {
                const response = await fetch('/api/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'same-origin',
                    body: JSON.stringify({ name, email, password })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    isAuthenticated = true;
                    currentUser = data.user;
                    updateNavForLoggedIn();
                    closeAuthModal();
                    showAuthMessage('Account created successfully!', false);
                } else {
                    showAuthMessage(data.error || 'Registration failed. Please try again.', true);
                }
            } catch (err) {
                console.error('Registration error:', err);
                showAuthMessage('Network error. Please check your connection.', true);
            }
        }

        async function handleLogout() {
            if (!confirm('Are you sure you want to sign out?')) {
                return;
            }
            
            try {
                await fetch('/api/logout', { 
                    method: 'POST',
                    credentials: 'same-origin'
                });
                
                isAuthenticated = false;
                currentUser = null;
                updateNavForGuest();
                
                // Clear results
                document.getElementById('results-area').classList.add('hidden');
                document.getElementById('error-area').classList.add('hidden');
                
            } catch (err) {
                console.error('Logout error:', err);
                alert('Logout failed. Please try again.');
            }
        }

        // ==================== SEARCH HANDLER (THE HOOK) ====================
        async function handleSearchSubmit(event) {
            event.preventDefault();
            
            // THE HOOK: Check if user is logged in
            if (!isAuthenticated || !currentUser) {
                // INTERCEPT: Open register modal instead of searching
                openAuthModal('register');
                return;
            }
            
            // User is logged in: Proceed with search
            await performSearch();
        }

        async function performSearch() {
            const type = document.getElementById('biz-type').value;
            const location = document.getElementById('location').value.trim();
            const purpose = document.getElementById('purpose').value.trim();
            
            if (!location) {
                alert('Please enter your location');
                return;
            }
            
            // Reset UI
            document.getElementById('results-area').classList.add('hidden');
            document.getElementById('error-area').classList.add('hidden');
            document.getElementById('loader-area').classList.remove('hidden');
            
            try {
                const response = await fetch('/api/search', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'same-origin',
                    body: JSON.stringify({ 
                        type, 
                        location, 
                        purpose: purpose || 'General funding'
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    // Check if it's a rate limit error
                    if (response.status === 429 && data.error && data.error.includes('Free limit reached')) {
                        showRateLimitError(data.error);
                        document.getElementById('loader-area').classList.add('hidden');
                        return;
                    }
                    throw new Error(data.error || 'Search failed');
                }
                
                if (Array.isArray(data) && data.length > 0) {
                    renderResults(data);
                } else {
                    throw new Error('No results found. Try adjusting your search criteria.');
                }
                
            } catch (err) {
                console.error('Search error:', err);
                document.getElementById('error-msg').textContent = err.message;
                document.getElementById('error-area').classList.remove('hidden');
            } finally {
                document.getElementById('loader-area').classList.add('hidden');
            }
        }

        // ==================== RATE LIMIT ERROR HANDLER ====================
        function showRateLimitError(errorMessage) {
            const errorArea = document.getElementById('error-area');
            const errorMsgDiv = document.getElementById('error-msg');
            
            errorMsgDiv.innerHTML = `
                <div class="flex items-start justify-between">
                    <div class="flex-1">
                        <p class="font-semibold mb-2">${errorMessage}</p>
                        <p class="text-sm">Upgrade to Pro for unlimited AI searches and priority support.</p>
                    </div>
                    <button 
                        onclick="startCheckout()" 
                        class="ml-4 bg-gradient-to-r from-yellow-500 to-orange-500 hover:from-yellow-600 hover:to-orange-600 text-white font-semibold px-6 py-2 rounded-lg shadow-md transition transform hover:-translate-y-0.5 flex items-center whitespace-nowrap"
                    >
                        <i class="fas fa-crown mr-2"></i> Upgrade Now
                    </button>
                </div>
            `;
            
            errorArea.classList.remove('hidden');
        }

        // ==================== RENDER RESULTS ====================
        function renderResults(results) {
            const container = document.getElementById('results-container');
            document.getElementById('result-count').textContent = `${results.length} opportunities found`;
            
            let html = '';
            
            results.forEach((item, index) => {
                let borderClass = 'border-blue-500';
                let bgClass = 'bg-blue-100 text-blue-800';
                let icon = 'fa-dollar-sign';
                
                const itemType = (item.type || '').toLowerCase();
                
                if (itemType.includes('grant')) {
                    borderClass = 'border-green-500';
                    bgClass = 'bg-green-100 text-green-800';
                    icon = 'fa-gift';
                } else if (itemType.includes('loan')) {
                    borderClass = 'border-purple-500';
                    bgClass = 'bg-purple-100 text-purple-800';
                    icon = 'fa-hand-holding-usd';
                } else if (itemType.includes('investor')) {
                    borderClass = 'border-yellow-500';
                    bgClass = 'bg-yellow-100 text-yellow-800';
                    icon = 'fa-user-tie';
                }
                
                html += `
                <div class="bg-white shadow-md rounded-xl p-6 border-l-4 ${borderClass} hover:shadow-lg transition-all duration-200 fade-in">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex-1">
                            <div class="flex items-center space-x-2 mb-3">
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold ${bgClass}">
                                    <i class="fas ${icon} mr-1"></i> ${item.type || 'Opportunity'}
                                </span>
                            </div>
                            <h4 class="text-xl font-bold text-gray-900 mb-2">${item.name || 'Funding Opportunity'}</h4>
                            <p class="text-sm text-gray-600 leading-relaxed">${item.match_reason || 'Matches your criteria'}</p>
                        </div>
                        <div class="text-right ml-4">
                            <div class="font-bold text-lg text-gray-900">${item.amount || 'Varies'}</div>
                            <div class="text-xs text-gray-500 mt-1">
                                <i class="far fa-calendar-alt mr-1"></i>${item.deadline || 'Rolling'}
                            </div>
                        </div>
                    </div>
                    <div class="pt-4 border-t border-gray-100 flex justify-between items-center">
                        <button 
                            onclick='saveOpportunity(${JSON.stringify(item).replace(/'/g, "&#39;")})' 
                            class="text-gray-600 hover:text-blue-600 font-medium text-sm transition flex items-center"
                        >
                            <i class="far fa-bookmark mr-2"></i> Save for Later
                        </button>
                        <a 
                            href="${item.link || '#'}" 
                            target="_blank" 
                            rel="noopener noreferrer"
                            class="bg-blue-600 hover:bg-blue-700 text-white font-medium text-sm px-4 py-2 rounded-lg transition flex items-center"
                        >
                            Apply Now <i class="fas fa-external-link-alt ml-2"></i>
                        </a>
                    </div>
                </div>`;
            });
            
            container.innerHTML = html;
            document.getElementById('results-area').classList.remove('hidden');
            
            // Scroll to results
            document.getElementById('results-area').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // ==================== SAVE OPPORTUNITY ====================
        async function saveOpportunity(item) {
            if (!isAuthenticated) {
                alert('Please log in to save opportunities');
                openAuthModal('login');
                return;
            }
            
            try {
                const response = await fetch('/api/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'same-origin',
                    body: JSON.stringify(item)
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    alert('✓ Opportunity saved successfully!');
                } else {
                    alert('Failed to save: ' + (data.error || 'Unknown error'));
                }
            } catch (err) {
                console.error('Save error:', err);
                alert('Network error. Please try again.');
            }
        }

        // ==================== LOAD SAVED ITEMS ====================
        async function loadSavedItems(event) {
            event.preventDefault();
            
            if (!isAuthenticated) {
                alert('Please log in to view saved items');
                openAuthModal('login');
                return;
            }
            
            try {
                const response = await fetch('/api/saved', {
                    method: 'GET',
                    credentials: 'same-origin'
                });
                
                const data = await response.json();
                
                if (response.ok && data.items) {
                    if (data.items.length === 0) {
                        alert('You have no saved items yet. Start searching to find opportunities!');
                    } else {
                        renderSavedItems(data.items);
                    }
                } else {
                    alert('Failed to load saved items: ' + (data.error || 'Unknown error'));
                }
            } catch (err) {
                console.error('Load saved items error:', err);
                alert('Network error. Please try again.');
            }
        }

        function renderSavedItems(items) {
            // Clear search form and hide other sections
            document.getElementById('error-area').classList.add('hidden');
            document.getElementById('loader-area').classList.add('hidden');
            
            const container = document.getElementById('results-container');
            document.getElementById('result-count').textContent = `${items.length} saved opportunities`;
            
            let html = '';
            
            items.forEach(item => {
                let borderClass = 'border-blue-500';
                let bgClass = 'bg-blue-100 text-blue-800';
                let icon = 'fa-dollar-sign';
                
                const itemType = (item.type || '').toLowerCase();
                
                if (itemType.includes('grant')) {
                    borderClass = 'border-green-500';
                    bgClass = 'bg-green-100 text-green-800';
                    icon = 'fa-gift';
                } else if (itemType.includes('loan')) {
                    borderClass = 'border-purple-500';
                    bgClass = 'bg-purple-100 text-purple-800';
                    icon = 'fa-hand-holding-usd';
                } else if (itemType.includes('investor')) {
                    borderClass = 'border-yellow-500';
                    bgClass = 'bg-yellow-100 text-yellow-800';
                    icon = 'fa-user-tie';
                }
                
                const savedDate = new Date(item.created_at).toLocaleDateString();
                
                html += `
                <div class="bg-white shadow-md rounded-xl p-6 border-l-4 ${borderClass} hover:shadow-lg transition-all duration-200">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex-1">
                            <div class="flex items-center space-x-2 mb-3">
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold ${bgClass}">
                                    <i class="fas ${icon} mr-1"></i> ${item.type || 'Opportunity'}
                                </span>
                                <span class="text-xs text-gray-500">
                                    <i class="far fa-clock mr-1"></i>Saved on ${savedDate}
                                </span>
                            </div>
                            <h4 class="text-xl font-bold text-gray-900 mb-2">${item.name || 'Funding Opportunity'}</h4>
                            <p class="text-sm text-gray-600 leading-relaxed">${item.match_reason || ''}</p>
                        </div>
                        <div class="text-right ml-4">
                            <div class="font-bold text-lg text-gray-900">${item.amount || 'Varies'}</div>
                            <div class="text-xs text-gray-500 mt-1">
                                <i class="far fa-calendar-alt mr-1"></i>${item.deadline || 'Rolling'}
                            </div>
                        </div>
                    </div>
                    <div class="pt-4 border-t border-gray-100 flex justify-end">
                        <a 
                            href="${item.link || '#'}" 
                            target="_blank" 
                            rel="noopener noreferrer"
                            class="bg-blue-600 hover:bg-blue-700 text-white font-medium text-sm px-4 py-2 rounded-lg transition flex items-center"
                        >
                            Apply Now <i class="fas fa-external-link-alt ml-2"></i>
                        </a>
                    </div>
                </div>`;
            });
            
            container.innerHTML = html;
            document.getElementById('results-area').classList.remove('hidden');
            
            // Scroll to results
            document.getElementById('results-area').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // ==================== STRIPE CHECKOUT ====================
        async function openPortal() {
            if (!isAuthenticated || !currentUser) {
                alert('Please log in to manage your subscription');
                openAuthModal('login');
                return;
            }
            
            try {
                // Show loading state
                const portalBtn = document.getElementById('portal-btn');
                const originalText = portalBtn ? portalBtn.innerHTML : '';
                if (portalBtn) {
                    portalBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Loading...';
                    portalBtn.disabled = true;
                }
                
                // Get portal session
                const response = await fetch('/api/portal', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'same-origin'
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to open portal');
                }
                
                // Redirect to Stripe portal
                window.location.href = data.url;
            } catch (error) {
                console.error('Portal error:', error);
                alert('Failed to open customer portal: ' + error.message);
                
                // Restore button
                const portalBtn = document.getElementById('portal-btn');
                if (portalBtn) {
                    portalBtn.innerHTML = '<i class="fas fa-cog mr-1"></i> Manage Subscription';
                    portalBtn.disabled = false;
                }
            }
        }
        
        async function startCheckout() {
            if (!isAuthenticated || !currentUser) {
                alert('Please log in to upgrade your account');
                openAuthModal('login');
                return;
            }
            
            try {
                // Show loading state
                const upgradeBtn = document.getElementById('upgrade-btn');
                const originalText = upgradeBtn ? upgradeBtn.innerHTML : '';
                if (upgradeBtn) {
                    upgradeBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Processing...';
                    upgradeBtn.disabled = true;
                }
                
                // Create checkout session
                const response = await fetch('/api/checkout', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'same-origin'
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to create checkout session');
                }
                
                if (data.sessionId) {
                    // Redirect to Stripe Checkout
                    window.location.href = `https://checkout.stripe.com/pay/${data.sessionId}`;
                } else {
                    throw new Error('No session ID returned');
                }
                
            } catch (err) {
                console.error('Checkout error:', err);
                alert('Failed to start checkout: ' + err.message);
                
                // Restore button state
                const upgradeBtn = document.getElementById('upgrade-btn');
                if (upgradeBtn) {
                    upgradeBtn.innerHTML = '<i class="fas fa-crown mr-1"></i> Upgrade to Pro';
                    upgradeBtn.disabled = false;
                }
            }
        }
    </script>
</body>
</html>